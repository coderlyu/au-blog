# HTTPS

## HTTPS 通过 TLS 建立连接的过程

### **HTTPS 通过 TLS 建立连接的详细过程**

HTTPS 使用 **TLS**（Transport Layer Security）协议来实现加密通信。在建立连接时，客户端和服务器之间会进行一个**TLS 握手（Handshake）**，用来协商加密算法、密钥，并验证服务器的合法性。

下面我们详细讲解 HTTPS 建立连接时，TLS 握手的具体过程。

---

### **1. 总体流程概述**

**客户端**和**服务器**通过以下步骤完成安全连接：

1. **客户端 Hello**
2. **服务器 Hello**
3. **服务器证书发送**
4. **密钥交换与对称密钥生成**
5. **握手结束，安全通信开始**

---

### **2. TLS 握手的详细步骤**

#### **步骤 1：客户端 Hello**

- **客户端**向服务器发起请求，请求建立加密通信。
- 内容包含：
  - **支持的加密算法列表**（如 AES、RSA、ECDSA）。
  - **TLS 协议版本**（如 TLS 1.2 或 TLS 1.3）。
  - **随机数**（Client Random），用于生成对称密钥。
  - **会话 ID**（如果是重用会话则会携带）。

> **作用**：告诉服务器它支持哪些算法，并为加密密钥生成贡献一部分随机数。

---

#### **步骤 2：服务器 Hello**

- **服务器**收到请求后，选择一组**客户端支持的加密算法**，并返回响应。
- 内容包含：
  - **选定的加密算法**。
  - **服务器的 TLS 版本**。
  - **服务器的随机数**（Server Random）。
  - **会话 ID**（用于会话重用）。

> **作用**：服务器选择要使用的加密算法，并提供自己的随机数。

---

#### **步骤 3：服务器证书发送**

- 服务器向客户端发送它的**数字证书**，用于证明服务器的身份。
- **证书内容**：

  - **服务器的公钥**。
  - **证书签发机构（CA）信息**。
  - **证书的有效期**、**服务器域名**等信息。

- **客户端验证证书**：
  1. 检查证书是否由受信任的**CA（证书颁发机构）**签发。
  2. 检查证书是否**过期**或是否被吊销。
  3. 检查证书中的域名是否与访问的服务器域名匹配。

> **作用**：确保客户端连接的服务器是真实的，而不是中间人。

---

#### **步骤 4：密钥交换与对称密钥生成**

客户端和服务器会使用一种**密钥交换算法**来协商**对称加密密钥**（用于后续的数据传输加密）。根据使用的密钥交换算法，流程略有不同：

##### **(1) 基于 RSA 的密钥交换**

- **客户端**使用服务器的**公钥**对一个**随机数（Pre-master Key）**进行加密，并发送给服务器。
- **服务器**使用自己的**私钥**解密这个随机数。
- 客户端和服务器使用**Client Random + Server Random + Pre-master Key**共同生成最终的**对称加密密钥**。

##### **(2) 基于 DH/ECDH 的密钥交换**

- 双方使用 **Diffie-Hellman** 或 **椭圆曲线 Diffie-Hellman（ECDH）** 算法来协商对称密钥，而无需直接传输密钥。
- 这种方式更加安全，因为即使中间人截获了数据，也无法恢复密钥。

> **作用**：确保客户端和服务器使用相同的对称加密密钥进行通信。

---

#### **步骤 5：握手结束，开始加密通信**

1. **客户端发送 Finished 消息**：表示握手阶段结束，并使用协商好的对称密钥加密该消息。
2. **服务器发送 Finished 消息**：服务器也用对称密钥加密并发送确认消息。

> **作用**：双方确认使用的加密密钥无误，握手过程完成。

---

### **3. 数据传输阶段**

- 握手完成后，客户端和服务器使用**对称加密算法**（如 AES）进行数据加密传输。
- 每次发送的数据都会附带**MAC（Message Authentication Code）**，确保数据的**完整性**。

---

### **4. TLS 握手的简化流程图**

```plaintext
Client Hello  --------->  Server Hello
                    <-----  Server Certificate
Client Key Exchange  --------->  [Encrypted Key]
Finished (Encrypted)  <----->  Finished (Encrypted)
```

---

### **5. 总结**

- **HTTPS** 建立连接时通过 **TLS** 协议来确保通信安全。
- 握手阶段中，客户端和服务器协商加密算法，验证证书，并生成**对称加密密钥**。
- 握手完成后，双方使用协商好的密钥进行加密通信。

---

### **6. 常见问题**

1. **为什么使用对称加密传输数据而不是公钥加密？**

   - **对称加密**效率更高，适合大量数据传输。而公钥加密主要用于握手中的密钥交换。

2. **TLS 1.2 与 TLS 1.3 有什么区别？**

   - TLS 1.3 移除了不安全的算法（如 RSA 密钥交换），简化了握手过程，提高了速度和安全性。

3. **HTTPS 为什么比 HTTP 慢？**
   - HTTPS 需要额外的握手过程，并进行加密解密操作，因此比 HTTP 稍慢。

---

### **7. 总体流程一览**

1. **客户端发送 Client Hello**（包含支持的算法和随机数）。
2. **服务器回复 Server Hello**（选择算法并返回随机数）。
3. **服务器发送证书**（用于身份验证）。
4. **客户端和服务器协商密钥**（基于 RSA 或 DH 算法）。
5. **握手完成**，双方使用对称密钥进行加密通信。

这样，HTTPS 通过 TLS 保证了通信的**机密性、完整性和身份认证**。

## 客户端和服务器协商密钥的安全性如何保证

在 HTTPS 连接的 **TLS 握手**过程中，客户端和服务器需要协商一个**对称加密密钥**，用于后续数据的加密传输。但为了避免中间人攻击和密钥泄露，TLS 设计了多种**密钥交换算法**来确保密钥的安全性。下面我们详细讲解如何通过 **RSA**、**DH/ECDH** 等算法保障密钥交换的安全性。

---

### **TLS 握手中的密钥交换及其安全性保障**

#### **1. 面临的安全威胁**

- **中间人攻击**：攻击者假冒服务器或客户端，截获密钥。
- **被动窃听**：攻击者窃取通信内容，恢复密钥。
- **重放攻击**：攻击者拦截并重放通信数据。

#### **2. 两种常见的密钥交换方式**

TLS 主要通过 **RSA** 或 **DH/ECDH** 进行密钥交换，不同方式的安全性实现略有差异。

---

### **密钥交换算法的详细流程及其安全性**

#### **方案 1：基于 RSA 的密钥交换**

1. **服务器的公钥和证书发送**：

   - 服务器将**公钥**嵌入**数字证书**中，发送给客户端。
   - 客户端会验证证书是否由受信任的 CA 签发，并检查证书是否有效。

2. **客户端生成 Pre-Master Secret**：

   - 客户端生成一个**Pre-Master Secret**（预主密钥），用服务器的**公钥**加密它，并发送给服务器。

3. **服务器解密 Pre-Master Secret**：

   - 服务器用自己的**私钥**解密 Pre-Master Secret。

4. **生成对称密钥**：
   - 客户端和服务器基于 `Client Random + Server Random + Pre-Master Secret` 生成最终的**对称加密密钥**。

##### **安全性保障**：

- **非对称加密**：Pre-Master Secret 用服务器的**公钥**加密，只有服务器的**私钥**可以解密，保证中间人无法窃取密钥。
- **防止重放攻击**：握手中的随机数（Client Random、Server Random）保证每次握手都不一样。
- **缺点**：如果服务器的私钥泄露，攻击者可以解密 Pre-Master Secret 并恢复对称密钥。

---

#### **方案 2：基于 DH/ECDH 的密钥交换（推荐方案）**

**Diffie-Hellman（DH）**和**椭圆曲线 Diffie-Hellman（ECDH）** 是一种安全的密钥交换算法。它无需直接传输密钥，而是通过双方的私钥和公钥计算出相同的密钥。

##### **流程**：

1. **服务器发送公钥（或公钥参数）**：

   - 服务器生成一个**DH/ECDH 公私钥对**，并将公钥（或公钥参数）发送给客户端。

2. **客户端生成自己的公钥并发送**：

   - 客户端生成自己的**公私钥对**，并将公钥发送给服务器。

3. **双方计算共享密钥**：

   - 客户端和服务器根据对方的**公钥**和自己的**私钥**，通过 DH/ECDH 算法计算出相同的**共享密钥**。

4. **生成对称加密密钥**：
   - 双方基于共享密钥和随机数，生成用于加密数据的对称密钥。

##### **安全性保障**：

- **前向保密（Perfect Forward Secrecy，PFS）**：
  - 即使服务器的私钥泄露，攻击者也无法解密之前的通信内容，因为密钥是每次握手动态生成的。
- **避免密钥传输**：密钥不会直接在网络上传输，避免了被截获的风险。
- **椭圆曲线加密（ECDH）**：相比传统 DH，ECDH 使用更短的密钥长度即可提供更高的安全性。

---

#### **3. 如何应对中间人攻击（MITM）？**

- **数字证书验证**：客户端会验证服务器证书是否由受信任的**CA**（Certificate Authority）签发，并检查其**有效性**。
- **证书链与根证书信任**：客户端通过根证书和中间证书链，验证服务器的证书是否可信。
- **公钥指纹校验**：客户端可以校验服务器的公钥指纹，以防止攻击者使用伪造的证书。

---

#### **4. TLS 1.2 与 TLS 1.3 的改进**

- **TLS 1.3 移除了 RSA 密钥交换**：因为 RSA 不具备前向保密性，TLS 1.3 强制使用 **DH/ECDH** 方案。
- **握手流程优化**：TLS 1.3 减少了握手中的往返次数，提高了连接速度，同时增强了安全性。

---

#### **5. 总结：如何确保密钥交换的安全性**

1. **非对称加密（RSA）**：确保只有服务器能解密密钥，防止中间人窃取。
2. **前向保密（PFS）**：使用 **DH/ECDH** 动态生成密钥，即使服务器私钥泄露，也无法解密历史数据。
3. **数字证书验证**：确保客户端连接的是真实的服务器，而非中间人。
4. **TLS 1.3**：通过移除不安全的算法和优化握手，进一步提升安全性。

---

#### **6. 总体流程图**

```plaintext
Client Hello  --------->  Server Hello
                    <-----  Server Certificate
Client Key Exchange  <----->  Server Key Exchange
Finished (Encrypted) <-----> Finished (Encrypted)
```

通过上述机制，HTTPS 使用 TLS 协商安全密钥，并确保密钥在传输过程中不会被窃取，保障通信的**机密性、完整性和身份验证**。
