name: Publish And Deploy Demo # 自动部署的名称

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # 运行环境，告诉它运行在什么环境
    steps: # 步骤
      # 第一步：下载源码（CI/CD拉取代码到自己的本地）
      - name: Checkout
        uses: actions/checkout@master

      # 第二步：打包构建
      - name: Build
        uses: actions/setup-node@master
      - run: npm install # 安装第三方包
      - run: npm run build # 打包
      - run: tar -czvf blog.tgz ./webView/*

      # 第三步：部署到服务器
      - name: Deploy
        uses: appleboy/ssh-action@master # 使用ssh链接服务器
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.KEY }}
          script:
            | # 执行命令（运行到服务器）cd：要确保服务器有这个目录； wget：下载上一步的release到服务器； tar：解压； 安装依赖；启动服务
            cd /usr/web/html/blog
            wget https://github.com/coderlyu/au-blog/tree/master/webView/blog.tgz
            rm -rf ./*
            tar xzvf blog.tgz
