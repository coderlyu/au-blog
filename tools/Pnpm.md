# Pnpm

> [Document](https://pnpm.io/zh/motivation)

## 简介

pnpm（Performant NPM）是一个快速、节省磁盘空间的包管理工具，和传统的 NPM、Yarn 相比有很多优势。以下是关于 pnpm 的详细介绍：

### pnpm 的特点

1. **性能优越**：

   - **安装速度快**：pnpm 使用了基于符号链接的存储方式，避免了重复安装相同的依赖包，极大地提升了安装速度。
   - **依赖关系处理**：pnpm 能更好地处理依赖冲突和嵌套依赖，确保项目依赖关系的正确性。

2. **节省磁盘空间**：

   - **符号链接**：pnpm 会将所有安装的包存储在全局的存储中，然后在每个项目中创建符号链接指向这些包，从而减少了重复包的占用空间。
   - **去重机制**：pnpm 的包管理机制确保每个包的每个版本只在硬盘上存储一次，极大地节省了磁盘空间。

3. **一致性**：
   - **严格依赖树**：pnpm 安装时会严格遵守依赖关系，确保每个包的依赖版本是一致的，减少因为依赖版本不一致导致的问题。
   - **不可变锁文件**：pnpm 生成的`pnpm-lock.yaml`文件会记录依赖的精确版本，确保不同环境下安装的一致性。

### 安装 pnpm

你可以使用 NPM 或 Yarn 来安装 pnpm：

```bash
npm install -g pnpm
# 或者
yarn global add pnpm
```

### 基本命令

> [Document](https://pnpm.io/zh/cli/add)

#### 初始化项目

和 npm 一样，使用 pnpm 初始化项目：

```bash
pnpm init
```

#### 安装依赖

使用`pnpm install`或`pnpm add`命令来安装依赖：

```bash
pnpm install            # 安装项目中所有依赖
pnpm add <package>      # 添加一个新的依赖
pnpm add -D <package>   # 添加一个开发依赖
pnpm add <package>@<version>  # 安装指定版本的依赖
```

#### 移除依赖

使用`pnpm remove`命令来移除依赖：

```bash
pnpm remove <package>
```

#### 更新依赖

使用`pnpm update`命令来更新依赖：

```bash
pnpm update
```

#### 运行脚本

和 npm 一样，使用`pnpm run`来运行脚本：

```bash
pnpm run <script>
```

### 高级功能

#### 工作空间

pnpm 支持工作空间，可以在单个仓库中管理多个项目（包）。在项目根目录下创建一个`pnpm-workspace.yaml`文件：

```yaml
packages:
  - "packages/**"
  - "apps/**"
```

然后在各个子项目中分别添加`package.json`文件，并使用 pnpm 命令进行管理。

#### 全局安装

你也可以使用 pnpm 全局安装包：

```bash
pnpm add -g <package>
```

#### 使用缓存

pnpm 使用全局缓存来存储下载的包，这样多个项目可以共享相同的依赖包：

```bash
pnpm store add <package>
```

### 迁移到 pnpm

如果你已经在使用 npm 或 yarn，你可以很容易地迁移到 pnpm：

1. **删除旧的`node_modules`和锁文件**：

   ```bash
   rm -rf node_modules package-lock.json yarn.lock
   ```

2. **使用 pnpm 安装依赖**：

   ```bash
   pnpm install
   ```

### 小结

pnpm 通过高效的包管理机制，不仅提升了安装速度，还减少了磁盘空间的占用，并且保证了依赖的一致性。它是一个值得考虑的 NPM 和 Yarn 的替代方案，尤其是对于大型项目或需要管理多个项目的工作空间时。

## 优缺点

### 优点

1. 高效性能：
   - 安装速度快：PNPM 使用符号链接来管理依赖包，避免了重复安装相同的依赖包，从而大大提高了安装速度。
   - 并行安装：PNPM 能够并行下载和安装依赖包，进一步加快了安装过程。
2. 节省磁盘空间：
   - 符号链接机制：PNPM 将所有安装的包存储在全局的存储区，然后在每个项目中创建符号链接指向这些包，从而减少了磁盘空间的占用。
   - 去重机制：同一个版本的包在硬盘上只存储一次，避免了重复存储相同的依赖包。
3. 一致性和安全性：

   - 严格模式：PNPM 默认使用严格模式安装依赖，确保每个包的依赖关系清晰、正确，减少了依赖冲突的可能性。
   - 不可变锁文件：PNPM 生成的 pnpm-lock.yaml 文件记录了依赖包的精确版本，确保在不同环境下安装的一致性。

4. 工作空间支持：
   - Monorepo 支持：PNPM 支持工作空间，可以在单个仓库中管理多个项目（包），提高了管理效率和开发体验。
5. 良好的兼容性：
   - 兼容性好：PNPM 可以兼容 NPM 的包仓库和大多数 NPM 包，易于迁移和使用。

### 缺点

1. 学习成本：
   - 命令差异：PNPM 的命令和 NPM、Yarn 略有不同，虽然大多数命令类似，但一些特性和用法需要重新学习，可能对新手开发者造成一些困扰。
2. 生态系统：
   - 相对较新：相比 NPM 和 Yarn，PNPM 的生态系统相对较新，虽然它能够兼容 NPM 的包仓库，但部分工具和插件可能需要适配。
3. 社区和支持：
   - 社区规模：虽然 PNPM 的社区在不断增长，但与 NPM 相比，社区规模和支持资源相对较小，可能在遇到问题时需要更多的时间寻找解决方案。
4. Windows 的符号链接问题：
   - 符号链接：在某些 Windows 环境下，符号链接可能会导致权限问题或性能问题，需要额外的配置和权限设置。

## Pnpm Npm 和 Yarn 区别

在前端开发中，NPM、PNPM 和 Yarn 是三种常见的包管理工具。它们在功能和使用上有很多相似之处，但也各自有独特的特点和优势。下面是对这三者的详细比较：

### 功能比较

> [官方的比较文档](https://pnpm.io/zh/feature-comparison)

| 功能                  | Pnpm                       | yarn                | npm                  |
| --------------------- | -------------------------- | ------------------- | -------------------- |
| 工作空间支持          | ✔️                         | ✔️                  | ✔️                   |
| Isolated node_modules | ✔️-默认                    | ✔️                  | ✔️                   |
| Hoisted node_modules  | ✔️                         | ✔️                  | ✔️-默认              |
| 自动安装 peers        | ✔️                         | ✖️                  | ✔️                   |
| 即插即用              | ✔️                         | ✔️-默认             | ✖️                   |
| 零安装                | ✖️                         | ✔️                  | ✖️                   |
| 修补依赖项            | ✔️                         | ✔️                  | ✖️                   |
| 管理 Node.js 版本     | ✔️                         | ✖️                  | ✖️                   |
| 有锁文件              | ✔️-pnpm-lock.yaml          | ✔️-yarn.lock        | ✔️-package-lock.json |
| 支持覆盖              | ✔️                         | ✔️-通过 resolutions | ✔️                   |
| 内容可寻址存储        | ✔️                         | ✖️                  | ✖️                   |
| 动态包执行            | ✔️-通过 pnpm dlx           | ✔️-通过 yarn dlx    | ✔️-通过 npx          |
| 辅助缓存              | ✔️                         | ✖️                  | ✖️                   |
| 列出许可证            | ✔️-通过 pnpm licenses list | ✔️-通过 插件        | ✖️                   |

**Npm 特点**

1. 默认包管理工具：NPM 是 Node.js 的默认包管理工具，最广泛使用。
2. 易用性：NPM 的命令和工作流程相对简单，新手容易上手。
3. 庞大的生态系统：NPM 拥有最大、最丰富的包仓库（npm registry），几乎所有的 JavaScript 开发者都会使用它。

**Pnpm 特点**
符号链接：PNPM 通过符号链接共享包，减少重复包的安装。
高效存储：PNPM 将所有安装的包存储在全局的存储中，并在每个项目中创建符号链接指向这些包。
严格模式：PNPM 默认使用严格模式安装依赖，确保依赖关系的清晰和正确。

**Yarn 特点**

1. 快速安装：Yarn 通过并行下载依赖包，大大加快了安装速度。
2. 确定性：Yarn 引入了 yarn.lock 文件，确保不同环境下依赖版本一致。
3. 高效缓存：Yarn 使用全局缓存，减少重复下载的时间和带宽消耗。

### 优点比较

#### Npm

**优点**

1. 内置：Node.js 安装包中已经包含了 NPM，不需要额外安装。
2. 简单易用：通过命令行可以很方便地管理项目依赖。

#### Pnpm

**优点**

1. 极快的安装速度：由于使用符号链接和全局存储，安装速度非常快。
2. 节省磁盘空间：同一版本的包只存储一次，大大减少了磁盘空间占用。
3. 一致性和安全性：严格模式确保了依赖关系的一致性和安全性。

#### Yarn

**优点**

1. 性能优越：安装速度快，依赖解析效率高。
2. 确定性安装：通过 yarn.lock 文件确保依赖版本一致。
3. 工作空间：支持在单个仓库中管理多个项目（monorepo），提高管理效率。

### 缺点比较

#### Npm

**缺点**

1. 性能问题：NPM 在处理大量依赖时，安装速度较慢，尤其是在依赖树深度较大时。
2. 磁盘空间浪费：每个项目都有自己的 node_modules 文件夹，容易造成磁盘空间浪费。

#### Pnpm

**缺点**

1. 工具链差异：PNPM 的命令和 NPM、Yarn 有所不同，需要一些学习成本。
2. 生态系统：PNPM 虽然可以使用 NPM 仓库，但部分工具和插件可能需要适配。

#### Yarn

**缺点**

1. 工具链变动：Yarn 的命令和 NPM 略有不同，可能需要一些学习成本。
2. 生态系统：虽然 Yarn 可以使用 NPM 仓库，但部分功能和插件可能不完全兼容。

### 比较总结

1. 性能：
   - PNPM：最快，节省磁盘空间。
   - Yarn：次快，通过并行下载和缓存提升速度。
   - NPM：相对较慢。
2. 磁盘空间：
   - PNPM：最节省磁盘空间，通过全局存储和符号链接。
   - Yarn：通过全局缓存减少重复下载。
   - NPM：每个项目都有独立的 node_modules 文件夹，磁盘空间占用大。
3. 一致性：
   - Yarn 和 PNPM：通过锁文件（yarn.lock 和 pnpm-lock.yaml）确保一致性。
   - NPM：也有 package-lock.json 文件，但在某些情况下可能不如 Yarn 和 PNPM 一致性好。
4. 易用性：
   - NPM：默认工具，最广泛使用，命令简单。
   - Yarn 和 PNPM：命令稍有不同，需要一些学习成本，但提供了更多高级功能。

### 总结

1. **NPM：**适合不需要高性能和空间优化的简单项目或新手开发者。
2. **Yarn：**适合需要快速安装和一致性管理的中大型项目。
3. **PNPM：**适合追求极高性能、节省磁盘空间和严格依赖管理的大型项目或 monorepo。
